<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGIN</title>
    <link rel="stylesheet" href="borrar.css">
</head>
<body>

<div class="tickets-container">
  <div class="tickets-header">
    <h2>√öltimos Tickets</h2>
    <button class="add-ticket-btn">+ Nuevo Ticket</button>
  </div>
  <table class="tickets-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>T√≠tulo</th>
        <th>Descripci√≥n</th>
        <th>Estado</th>
        <th>Prioridad</th>
        <th>Usuario</th>
        <th>Agente</th>
        <th>√öltima Actualizaci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  async function cargarTickets() {
    try {
      // Llama al webhook de n8n
      const res = await fetch("http://localhost:5678/webhook/tickets", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      const tickets = await res.json();

      const tbody = document.querySelector(".tickets-table tbody");
      tbody.innerHTML = "";

      tickets.forEach(ticket => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>#${ticket.id}</td>
          <td>${ticket.titulo}</td>
          <td>${ticket.descripcion}</td>
          <td>
            <span class="status-badge status-${ticket.estado}">
              ${ticket.estado}
            </span>
          </td>
          <td class="priority-${ticket.prioridad}">
            ${ticket.prioridad}
          </td>
          <td>${ticket.id_usuario}</td>
          <td>${ticket.id_asignado || "Sin asignar"}</td>
          <td>${new Date(ticket.fecha_actualizacion).toLocaleString()}</td>
        `;

        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error("Error cargando tickets:", error);
    }
  }

  // Ejecutar al cargar la p√°gina
  cargarTickets();
</script>




    <div id="LOGIN_CONTAINER">
        <form id="LOGIN_FORM">
          <img src="../../assets/logo_blue.png" alt="">
          <h2>Inicio De Sesion</h2>
          <input type="email" name="email" id="email" placeholder="email" required>
          <input type="password" name="password" id="password" placeholder="Contrase√±a" required>
          <button type="submit">Ingresar</button>
        </form>
    </div>
<script>
const LOGIN_URL = "http://localhost:5678/webhook/proxy";

document.getElementById("LOGIN_FORM").addEventListener("submit", async (event) => {
  event.preventDefault();

  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    const response = await fetch(LOGIN_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await response.json();
    if (data.success && data.token) {
      guardarTokenYRedirigir(data.token);
    } else {
      alert("Login fallido ‚ùå");
    }
  } catch (err) {
    console.error("Error de red:", err);
    alert("No se pudo conectar con el servidor üö®");
  }
});

// üîπ Guardar token en sessionStorage y redirigir
function guardarTokenYRedirigir(token) {
  // Eliminar token anterior
  sessionStorage.removeItem("jwtData");

  const expiraEn = Date.now() + 2 * 60 * 1000; // 2 minutos
  sessionStorage.setItem("jwtData", JSON.stringify({ token, expiraEn }));

  // Confirmar que se guard√≥ antes de redirigir
  if (sessionStorage.getItem("jwtData")) { // ‚ö†Ô∏è usar sessionStorage, no sessionStorage
    console.log("‚úÖ Token guardado correctamente:", token);
    window.location.href = "./dashboard/dashboard.html";
  } else {
    console.error("‚ùå No se pudo guardar el token");
  }
}

</script>




</body>
</html>